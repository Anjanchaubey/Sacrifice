<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caffine</title>
    <link rel="icon" type="image/png" href="logo.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Tailwind Config for Dark Mode and Colors -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fadeIn': 'fadeIn 0.2s ease-out',
                        'progress': 'progress 3s linear'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        progress: {
                            '0%': { width: '0%' },
                            '100%': { width: '100%' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Utilities */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
body {
            -webkit-tap-highlight-color: transparent;
            background-color: #fffbeb; /* Lighter amber beige */
        }
        .dark body {
            background-color: #000000; /* Pure Black */
        }
        /* Lock transition for smooth theme switch */
        * {
            transition-property: background-color, border-color, color, fill, stroke;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 300ms;
        }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        .dark #splash-screen {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        }
        #splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        #splash-logo {
            width: 120px;
            height: 120px;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Grid Color Shading */
        .grid-block {
            width: 100%;
            padding-top: 100%; /* Makes the block square */
            position: relative;
        }
        .grid-block div {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 0.5rem;
        }
        .hours-2 {
            background-color: #fde047; /* Yellowish */
        }
        .hours-4 {
            background-color: #c084fc; /* Purplish */
        }
        .hours-6 {
            background-color: #22d3ee; /* Neon cyan */
        }
        .hours-8 {
            background-color: #22c55e; /* Greenish */
        }
        .hours-more {
            background: linear-gradient(135deg, #ec4899, #8b5cf6); /* Brighter gradient */
        }
    </style>
</head>
<body class="text-slate-800 dark:text-amber-300 font-sans pb-20 selection:bg-amber-400 selection:text-black transition-colors duration-500">

    <!-- Splash Screen -->
    <div id="splash-screen">
        <img id="splash-logo" src="logo.png" alt="Caffine">
        <h1 class="text-2xl font-bold text-amber-600 dark:text-amber-400 mt-4">Caffine</h1>
    </div>

    <!-- App Container -->
    <div id="app" class="max-w-5xl mx-auto px-4 pt-6 md:px-12 md:pt-12">
        
        <!-- Header -->
        <header class="mb-6 flex flex-col gap-5 md:flex-row md:items-end justify-between">
            <div class="flex items-start justify-between w-full md:w-auto">
                <div>
                    <h1 class="text-3xl font-extrabold tracking-tight text-slate-900 dark:text-amber-300 flex items-center gap-3">
                        <img src="logo.png" alt="Caffine" class="w-16 h-16 stroke-[2.5px]">
                        Caffine
                    </h1>
                    <p id="start-date-display" class="text-slate-700 dark:text-amber-200 text-sm font-medium mt-1">
                        Loading...
                    </p>
                </div>
                <!-- Mobile Theme Toggle -->
                <button id="theme-toggle-mobile" class="md:hidden p-2.5 rounded-full bg-amber-100 dark:bg-amber-900 text-slate-600 dark:text-amber-300 active:scale-95 transition-transform">
                    <i data-lucide="moon" class="dark:hidden"></i>
                    <i data-lucide="sun" class="hidden dark:block"></i>
                </button>
            </div>

            <div class="flex flex-col-reverse md:flex-row md:items-center gap-4">
                <!-- Duration Toggles -->
                <div id="duration-container" class="flex bg-amber-100 dark:bg-amber-900 p-1.5 rounded-xl overflow-x-auto w-full md:w-auto scrollbar-hide">
                    <!-- Buttons injected by JS -->
                </div>

                <div class="hidden md:flex gap-2">
                    <button id="theme-toggle-desktop" class="p-3 rounded-full hover:bg-amber-100 dark:hover:bg-amber-900 transition-colors text-slate-600 dark:text-amber-300" title="Toggle Theme">
                        <i data-lucide="moon" class="dark:hidden"></i>
                        <i data-lucide="sun" class="hidden dark:block"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4 mb-6 md:mb-8">
            
            <!-- Cycling Streak Card -->
            <div id="streak-card" class="col-span-2 md:col-span-1 flex flex-col p-4 rounded-2xl border border-amber-100 dark:border-amber-800 transition-all duration-500 relative overflow-hidden bg-amber-50 dark:bg-amber-950/20">
                <!-- Content Injected JS -->
            </div>

            <!-- Total Hours Card -->
            <div class="flex flex-col p-4 rounded-2xl border border-amber-100 dark:border-amber-800 bg-amber-50 dark:bg-amber-950/20">
                <div class="mb-2 text-amber-500"><i data-lucide="clock" size="18"></i></div>
                <span id="stat-total-hours" class="text-2xl md:text-3xl font-bold text-slate-800 dark:text-amber-300 tracking-tight">0h</span>
                <span class="text-[10px] md:text-xs text-slate-500 dark:text-amber-400 font-bold uppercase tracking-wider opacity-80">Total Hours</span>
            </div>

            <!-- Days Logged Card -->
            <div class="flex flex-col p-4 rounded-2xl border border-amber-100 dark:border-amber-800 bg-amber-50 dark:bg-amber-950/20">
                <div class="mb-2 text-amber-500"><i data-lucide="calendar" size="18"></i></div>
                <span id="stat-days-logged" class="text-2xl md:text-3xl font-bold text-slate-800 dark:text-amber-300 tracking-tight">0</span>
                <span class="text-[10px] md:text-xs text-slate-500 dark:text-amber-400 font-bold uppercase tracking-wider opacity-80">Days Logged</span>
            </div>
        </div>

        <!-- The Grid -->
        <div class="bg-white dark:bg-black p-4 md:p-8 rounded-[2rem] shadow-xl shadow-amber-200/50 dark:shadow-none border border-amber-100 dark:border-amber-800/50 relative overflow-hidden">
            
            <!-- Glow Effect -->
            <div class="absolute top-0 right-0 -mt-20 -mr-20 w-80 h-80 bg-amber-400/10 rounded-full blur-[100px] pointer-events-none"></div>

            <!-- Grid Container -->
            <div id="grid-container" class="grid gap-1.5 md:gap-3 transition-all duration-500 relative z-10" style="grid-template-columns: repeat(auto-fill, minmax(38px, 1fr));">
                <!-- Blocks injected by JS -->
            </div>

            <!-- Legend -->
            <div class="mt-8 pt-6 border-t border-amber-100 dark:border-amber-800 flex overflow-x-auto pb-2 scrollbar-hide items-center md:justify-center gap-6 text-[10px] md:text-xs text-slate-500 dark:text-amber-400 font-semibold whitespace-nowrap">
                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-amber-100 dark:bg-amber-800"></div><span>0h</span></div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-yellow-300"></div><span>1-2h</span></div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-purple-400"></div><span>3-4h</span></div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-cyan-400"></div><span>5-6h</span></div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-green-500"></div><span>7-8h</span></div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-gradient-to-r from-pink-500 to-violet-600"></div><span>9h+</span></div>
            </div>
        </div>

        <div class="mt-6 text-center text-slate-400 dark:text-amber-500 text-xs font-medium md:hidden">
            Long press any block for details
        </div>
    </div>

    <!-- Popup Modal -->
    <div id="popup-backdrop" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-md p-4 animate-fadeIn">
        <div class="bg-white dark:bg-black w-full max-w-xs p-6 rounded-3xl shadow-2xl border border-amber-100 dark:border-amber-800 transform transition-all scale-100 relative">
            
            <!-- Popup Header -->
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 id="popup-date" class="text-xl font-bold text-slate-900 dark:text-amber-300 tracking-tight">Date</h3>
                    <p id="popup-status" class="text-sm text-slate-500 dark:text-amber-300 font-medium">Status</p>
                </div>
                <button id="popup-close" class="p-2 hover:bg-amber-100 dark:hover:bg-amber-800 rounded-full transition-colors">
                    <i data-lucide="x" class="text-slate-500 dark:text-amber-300 w-5 h-5"></i>
                </button>
            </div>

            <!-- Popup Display -->
            <div class="flex items-center gap-5 mb-6">
                <div id="popup-hours-box" class="relative w-16 h-16 rounded-2xl flex items-center justify-center text-3xl font-bold shadow-inner transition-colors duration-300">
                    <span id="popup-hours-val">0</span><span class="text-sm font-medium opacity-60 ml-0.5 mt-2">h</span>
                    <!-- Unlocked Dot -->
                    <div id="popup-unlocked-dot" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-green-500 border-2 border-white dark:border-zinc-950 rounded-full"></div>
                </div>
                
                <div class="flex-1">
                    <div id="popup-text-desc" class="text-sm font-semibold text-slate-700 dark:text-amber-200">No Activity</div>
                    <div class="w-full bg-amber-100 dark:bg-amber-900 rounded-full h-2 mt-2 overflow-hidden">
                        <div id="popup-progress-bar" class="bg-amber-400 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Controls: Locked State -->
            <button id="btn-unlock" class="w-full flex items-center justify-center gap-2 text-xs font-semibold text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/10 py-3 rounded-xl border border-amber-100 dark:border-amber-900/20 hover:bg-amber-100 dark:hover:bg-amber-900/30 transition-colors">
                <i data-lucide="lock" class="w-3.5 h-3.5"></i>
                <span>Unlock to Edit Grid</span>
            </button>

            <!-- Controls: Unlocked State -->
            <div id="controls-unlocked" class="hidden flex items-center gap-2">
                <button id="btn-minus" class="flex-1 flex items-center justify-center py-3 rounded-xl bg-amber-100 dark:bg-amber-900 text-slate-600 dark:text-amber-300 hover:bg-amber-200 dark:hover:bg-amber-800 transition-colors active:scale-95">
                    <i data-lucide="minus" class="w-4 h-4"></i>
                </button>
                
                <button id="btn-plus" class="flex-1 flex items-center justify-center py-3 rounded-xl bg-amber-50 dark:bg-amber-900/30 text-amber-600 dark:text-amber-300 hover:bg-amber-100 dark:hover:bg-amber-900/50 transition-colors active:scale-95">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                </button>

                <button id="btn-lock" class="px-4 py-3 rounded-xl bg-amber-100 dark:bg-amber-900 text-slate-400 dark:text-amber-400 hover:text-slate-600 dark:hover:text-amber-200 transition-colors" title="Lock Editing">
                    <i data-lucide="lock-open" class="w-4 h-4"></i>
                </button>
            </div>
            
            <!-- Readonly Warning (for future dates) -->
            <div id="msg-future" class="hidden text-xs text-center font-medium text-slate-400 dark:text-amber-500 py-3">
                Future dates cannot be edited yet.
            </div>

        </div>
    </div>

    <!-- Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCYY2GQqS0tCXb7Oxw8AWXhpexq9e8VRUs",
            authDomain: "aspirehub-32863.firebaseapp.com",
            projectId: "aspirehub-32863",
            storageBucket: "aspirehub-32863.appspot.com",
            messagingSenderId: "686810111182",
            appId: "1:686810111182:web:4290b4b1b6e64934ec449f",
            measurementId: "G-KX41R0SSMY",
            databaseURL: "https://aspirehub-32863-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- State ---
        let state = {
            user: null,
            history: {}, // "YYYY-MM-DD": hours
            duration: 400,
            darkMode: false,
            startDateStr: null
        };

        let popupState = {
            isOpen: false,
            date: null,
            hours: 0,
            isLocked: true // Controls UI lock
        };

        // --- Helpers ---
        const getLocalISODate = (date) => {
            const offset = date.getTimezoneOffset() * 60000;
            const localDate = new Date(date.getTime() - offset);
            return localDate.toISOString().split('T')[0];
        };

        const isSameDay = (d1, d2) => {
            return d1.getFullYear() === d2.getFullYear() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getDate() === d2.getDate();
        };

        const formatDate = (date) => {
            return new Intl.DateTimeFormat('en-US', { weekday: 'short', month: 'short', day: 'numeric' }).format(date);
        };

        // --- Save to Firestore ---
        const saveData = async () => {
            if (!state.user) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'tracker_data', 'v3_challenge_history'), {
                    history: state.history,
                    duration: state.duration,
                    darkMode: state.darkMode,
                    startDateStr: state.startDateStr
                }, { merge: true });
            } catch (e) { console.error("Save error", e); }
        };

        // --- Auth & Sync ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (u) => {
            state.user = u;
            if (u) {
                // Subscribe to data
                const docRef = doc(db, 'artifacts', appId, 'users', u.uid, 'tracker_data', 'v3_challenge_history');
                onSnapshot(docRef, (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        state.history = data.history || {};
                        state.duration = data.duration || 400;
                        state.darkMode = data.darkMode !== undefined ? data.darkMode : false;
                        state.startDateStr = data.startDateStr || getLocalISODate(new Date());
                    } else {
                        // Init new user
                        state.startDateStr = getLocalISODate(new Date());
                        saveData();
                    }
                    renderAll();
                });
            }
        });

        // --- Render Logic ---

        function renderAll() {
            applyTheme();
            renderHeader();
            renderStats();
            renderGrid();
            if (popupState.isOpen) updatePopupContent(); // Live update popup if open
            lucide.createIcons();
        }

        function applyTheme() {
            const html = document.documentElement;
            const body = document.body;
            
            if (state.darkMode) {
                html.classList.add('dark');
                body.classList.add('bg-black');
                body.classList.remove('bg-slate-50');
            } else {
                html.classList.remove('dark');
                body.classList.remove('bg-black');
                body.classList.add('bg-slate-50');
            }
        }

        function renderHeader() {
            // Start Date
            const dateEl = document.getElementById('start-date-display');
            if (state.startDateStr) {
                const [y, m, d] = state.startDateStr.split('-').map(Number);
                const startDate = new Date(y, m-1, d);
                dateEl.textContent = `Started ${formatDate(startDate)}`;
            }

            // Duration Buttons
            const container = document.getElementById('duration-container');
            container.innerHTML = '';
            [30, 60, 90, 400].forEach(d => {
                const btn = document.createElement('button');
                btn.className = `flex-1 md:flex-none px-4 py-2 text-xs md:text-sm font-bold rounded-lg whitespace-nowrap transition-all ${
                    state.duration === d 
                    ? 'bg-white dark:bg-amber-800 shadow-sm text-amber-600 dark:text-white' 
                    : 'text-slate-500 dark:text-amber-400 hover:text-slate-700 dark:hover:text-amber-200'
                }`;
                btn.textContent = `${d} Days`;
                btn.onclick = () => {
                    state.duration = d;
                    saveData(); // Save immediately triggers re-render via snapshot
                };
                container.appendChild(btn);
            });
        }

        // Streak Calculation Logic
        function calculateStreaks() {
            const todayStr = getLocalISODate(new Date());
            let checkDate = new Date();
            
            // If today is empty, check yesterday to preserve streak
            if ((state.history[todayStr] || 0) === 0) {
                checkDate.setDate(checkDate.getDate() - 1);
            }

            const runCheck = (threshold) => {
                let count = 0;
                let d = new Date(checkDate);
                // Limit loop
                for (let i=0; i<365; i++) {
                    const ds = getLocalISODate(d);
                    if ((state.history[ds] || 0) >= threshold) {
                        count++;
                        d.setDate(d.getDate() - 1);
                    } else {
                        break;
                    }
                }
                return count;
            };

            return {
                any: runCheck(1),
                medium: runCheck(5),
                deep: runCheck(8)
            };
        }

        // Cycling Streak Card Logic
        let streakInterval;
        let streakIndex = 0;
        
        function renderStats() {
            // Basic Stats
            const totalHours = Object.values(state.history).reduce((a,b) => a+b, 0);
            const daysLogged = Object.values(state.history).filter(h => h > 0).length;
            
            document.getElementById('stat-total-hours').textContent = `${totalHours}h`;
            document.getElementById('stat-days-logged').textContent = daysLogged;

            // Cycling Card
            if (!streakInterval) {
                renderStreakCard(); // First render
                streakInterval = setInterval(() => {
                    streakIndex = (streakIndex + 1) % 3;
                    renderStreakCard();
                    lucide.createIcons();
                }, 3000);
            } else {
                // Just update content if interval exists
                renderStreakCard();
            }
        }

        function renderStreakCard() {
            const streaks = calculateStreaks();
            const types = [
                { label: "Vigilante Streak", value: streaks.any, icon: "flame", color: "text-orange-500", bg: "bg-orange-50 dark:bg-orange-950/20" },
                { label: "Batcave Sessions", value: streaks.medium, icon: "sparkles", color: "text-purple-500", bg: "bg-purple-50 dark:bg-purple-950/20" },
                { label: "Dark Knight Streak", value: streaks.deep, icon: "trophy", color: "text-indigo-500", bg: "bg-indigo-50 dark:bg-indigo-950/20" }
            ];
            
            const current = types[streakIndex];
            const card = document.getElementById('streak-card');
            
            // Reset classes
            card.className = `col-span-2 md:col-span-1 flex flex-col p-4 rounded-2xl border border-slate-100 dark:border-zinc-800 transition-all duration-500 relative overflow-hidden ${current.bg}`;
            
            card.innerHTML = `
                <div class="mb-2 ${current.color} flex items-center justify-between">
                    <i data-lucide="${current.icon}" width="18" height="18"></i>
                    <div class="w-8 h-1 bg-black/5 dark:bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full bg-current opacity-50 animate-progress"></div>
                    </div>
                </div>
                <div class="animate-fadeIn">
                    <span class="text-3xl font-bold text-slate-800 dark:text-white block tracking-tight">
                        ${current.value} <span class="text-sm font-medium text-slate-500 dark:text-zinc-500">days</span>
                    </span>
                    <span class="text-[10px] md:text-xs text-slate-500 dark:text-zinc-400 font-bold uppercase tracking-wider opacity-80">${current.label}</span>
                </div>
            `;
        }

        function renderGrid() {
            const grid = document.getElementById('grid-container');
            grid.innerHTML = '';
            
            // Layout Columns based on duration
            const colSize = state.duration >= 365 ? '22px' : '38px';
            grid.style.gridTemplateColumns = `repeat(auto-fill, minmax(${colSize}, 1fr))`;

            // Generate Dates
            if (!state.startDateStr) return;
            const [y, m, d] = state.startDateStr.split('-').map(Number);
            const start = new Date(y, m-1, d);
            const today = new Date();
            const todayIso = getLocalISODate(today);

            for(let i=0; i<state.duration; i++) {
                const date = new Date(start);
                date.setDate(start.getDate() + i);
                const iso = getLocalISODate(date);
                const hours = state.history[iso] || 0;
                
                const isToday = iso === todayIso;
                const isFuture = date > today && !isToday;

                // Color Logic
                let colorClass = "bg-amber-100 dark:bg-amber-900 border-amber-200 dark:border-amber-800 text-transparent";
                if (hours > 0) {
                     if (hours <= 2) colorClass = "bg-yellow-300 border-yellow-400 text-yellow-900 shadow-[0_4px_12px_rgba(251,191,36,0.3)]";
                     else if (hours <= 4) colorClass = "bg-purple-400 border-purple-500 text-white shadow-[0_4px_12px_rgba(168,85,247,0.4)]";
                     else if (hours <= 6) colorClass = "bg-cyan-400 border-cyan-500 text-cyan-900 shadow-[0_4px_12px_rgba(34,211,238,0.4)]";
                     else if (hours <= 8) colorClass = "bg-green-500 border-green-600 text-white shadow-[0_4px_12px_rgba(34,197,94,0.4)]";
                     else if (hours <= 10) colorClass = "bg-blue-500 border-blue-600 text-white shadow-[0_4px_12px_rgba(59,130,246,0.5)]";
                     else if (hours <= 12) colorClass = "bg-indigo-600 border-indigo-700 text-white shadow-[0_4px_12px_rgba(99,102,241,0.5)]";
                     else colorClass = "bg-gradient-to-r from-pink-500 to-violet-600 border-pink-600 text-white shadow-[0_4px_16px_rgba(236,72,153,0.6)]";
                }

                const btn = document.createElement('button');
                btn.className = `
                    group relative w-full aspect-square rounded-md md:rounded-lg border-b-[3px] md:border-b-4 
                    ease-out touch-manipulation
                    flex items-center justify-center font-bold text-xs md:text-sm
                    focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-400 dark:focus:ring-offset-black
                    ${hours === 0 ? 'translate-y-0' : '-translate-y-[2px]'}
                    ${colorClass}
                    ${isToday ? 'ring-2 ring-offset-2 ring-amber-300 dark:ring-amber-400 animate-pulse-slow z-10' : ''}
                    ${isFuture ? 'opacity-30 cursor-not-allowed' : ''}
                    active:border-b-0 active:translate-y-[2px]
                `;

                // Icons/Text
                if (!isToday && hours === 0) {
                    btn.innerHTML = `<i data-lucide="lock" width="8" height="8" class="text-amber-300 dark:text-amber-700 absolute"></i>`;
                } else if (hours > 0) {
                    if (hours > 8) {
                        btn.innerHTML = `
                            <div class="relative flex flex-col items-center">
                                <svg class="w-3 h-3 text-yellow-400 mb-0.5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                                <span class="pointer-events-none select-none text-xs font-bold">${hours}</span>
                            </div>
                        `;
                    } else {
                        btn.innerHTML = `<span class="pointer-events-none select-none">${hours}</span>`;
                    }
                }

                // Interactions
                if (isFuture) {
                    btn.onclick = () => openPopup(date, hours);
                } else {
                    // Touch/Click Handling
                    let longPressTimer;
                    const handleTap = () => {
                        // If it's today, cycle. If past, open popup.
                        if (isToday) {
                            let next = hours === 0 ? 2 : (hours < 14 ? hours + 1 : 0);
                            state.history[iso] = next;
                            saveData();
                            // Optimistic update done by renderAll via snapshot listener mostly, 
                            // but we can manually triggering render could feel snappier.
                            // Firebase snapshot usually fast enough.
                        } else {
                            openPopup(date, hours);
                        }
                    };

                    const startPress = (e) => {
                         // e.preventDefault(); // Prevents scroll on some devices, careful
                         longPressTimer = setTimeout(() => {
                             openPopup(date, hours);
                             longPressTimer = null;
                         }, 600);
                    };
                    const cancelPress = () => {
                        if (longPressTimer) {
                            clearTimeout(longPressTimer);
                            longPressTimer = null;
                        }
                    };

                    btn.addEventListener('mousedown', startPress);
                    btn.addEventListener('touchstart', startPress, {passive: true});
                    btn.addEventListener('mouseup', (e) => {
                        if(longPressTimer) { 
                            clearTimeout(longPressTimer); 
                            handleTap(); 
                        }
                    });
                    btn.addEventListener('touchend', (e) => {
                        if(longPressTimer) { 
                            clearTimeout(longPressTimer); 
                            // Prevent default click firing if needed
                            handleTap(); 
                        }
                    });
                    btn.addEventListener('mouseleave', cancelPress);
                    btn.addEventListener('touchmove', cancelPress);
                }
                
                grid.appendChild(btn);
            }
        }

        // --- Popup Logic ---

        function openPopup(date, hours) {
            const isToday = isSameDay(date, new Date());
            popupState = {
                isOpen: true,
                date: date,
                hours: hours,
                isLocked: !isToday // Locked by default if not today
            };
            updatePopupContent();
            document.getElementById('popup-backdrop').classList.remove('hidden');
        }

        function closePopup() {
            popupState.isOpen = false;
            document.getElementById('popup-backdrop').classList.add('hidden');
        }

        function updatePopupContent() {
            const { date, hours, isLocked } = popupState;
            const isToday = isSameDay(date, new Date());
            const isFuture = date > new Date() && !isToday;

            // Header
            document.getElementById('popup-date').textContent = formatDate(date);
            document.getElementById('popup-status').textContent = isToday ? "Today" : isFuture ? "Future Goal" : "Past History";

            // Visuals
            const hoursBox = document.getElementById('popup-hours-box');
            const hoursVal = document.getElementById('popup-hours-val');
            const textDesc = document.getElementById('popup-text-desc');
            const progress = document.getElementById('popup-progress-bar');
            const unlockDot = document.getElementById('popup-unlocked-dot');

            hoursVal.textContent = hours;
            
            // Color box
            if (hours === 0) {
                hoursBox.className = "relative w-16 h-16 rounded-2xl flex items-center justify-center text-3xl font-bold shadow-inner transition-colors duration-300 bg-amber-100 dark:bg-amber-900 text-amber-400 dark:text-amber-500";
                textDesc.textContent = "No Activity";
            } else if (hours <= 2) {
                hoursBox.className = "relative w-16 h-16 rounded-2xl flex items-center justify-center text-3xl font-bold shadow-inner transition-colors duration-300 bg-yellow-300 text-yellow-900";
                textDesc.textContent = "Robin's Training";
            } else if (hours <= 4) {
                hoursBox.className = "relative w-16 h-16 rounded-2xl flex items-center justify-center text-3xl font-bold shadow-inner transition-colors duration-300 bg-purple-400 text-white";
                textDesc.textContent = "Nightwing Mode";
            } else if (hours <= 6) {
                hoursBox.className = "relative w-16 h-16 rounded-2xl flex items-center justify-center text-3xl font-bold shadow-inner transition-colors duration-300 bg-cyan-400 text-cyan-900";
                textDesc.textContent = "Batcave Focus";
            } else if (hours <= 8) {
                hoursBox.className = "relative w-16 h-16 rounded-2xl flex items-center justify-center text-3xl font-bold shadow-inner transition-colors duration-300 bg-green-500 text-white";
                textDesc.textContent = "Dark Knight";
            } else if (hours <= 10) {
                hoursBox.className = "relative w-16 h-16 rounded-2xl flex items-center justify-center text-3xl font-bold shadow-inner transition-colors duration-300 bg-blue-500 text-white";
                textDesc.textContent = "Gotham Guardian";
            } else if (hours <= 12) {
                hoursBox.className = "relative w-16 h-16 rounded-2xl flex items-center justify-center text-3xl font-bold shadow-inner transition-colors duration-300 bg-indigo-600 text-white";
                textDesc.textContent = "World's Greatest Detective";
            } else {
                hoursBox.className = "relative w-16 h-16 rounded-2xl flex items-center justify-center text-3xl font-bold shadow-inner transition-colors duration-300 bg-gradient-to-r from-pink-500 to-violet-600 text-white";
                textDesc.textContent = "Justice League Level";
            }

            // Progress Bar
            progress.style.width = `${Math.min((hours / 14) * 100, 100)}%`;

            // Unlocked Dot
            if (!isLocked) unlockDot.classList.remove('hidden');
            else unlockDot.classList.add('hidden');

            // Controls
            const btnUnlock = document.getElementById('btn-unlock');
            const controls = document.getElementById('controls-unlocked');
            const msgFuture = document.getElementById('msg-future');

            btnUnlock.classList.add('hidden');
            controls.classList.add('hidden');
            msgFuture.classList.add('hidden');

            if (isFuture) {
                msgFuture.classList.remove('hidden');
            } else if (isLocked) {
                btnUnlock.classList.remove('hidden');
            } else {
                controls.classList.remove('hidden');
            }
        }

        function adjustPopupHours(delta) {
            let newH = Math.max(0, Math.min(14, popupState.hours + delta));
            popupState.hours = newH;
            
            // Update History
            const iso = getLocalISODate(popupState.date);
            state.history[iso] = newH;
            saveData();
            
            // Re-render local immediately
            updatePopupContent();
        }

        // --- Event Listeners for Static UI ---

        // Popup Buttons
        document.getElementById('popup-close').onclick = closePopup;
        document.getElementById('popup-backdrop').onclick = (e) => {
            if(e.target.id === 'popup-backdrop') closePopup();
        };
        document.getElementById('btn-unlock').onclick = () => {
            popupState.isLocked = false;
            updatePopupContent();
        };
        document.getElementById('btn-lock').onclick = () => {
            popupState.isLocked = true;
            updatePopupContent();
        };
        document.getElementById('btn-minus').onclick = () => adjustPopupHours(-1);
        document.getElementById('btn-plus').onclick = () => adjustPopupHours(1);

        // Header Buttons
        const toggleTheme = () => {
            state.darkMode = !state.darkMode;
            applyTheme();
            saveData();
        };
        document.getElementById('theme-toggle-mobile').onclick = toggleTheme;
        document.getElementById('theme-toggle-desktop').onclick = toggleTheme;

        // Splash Screen
        setTimeout(() => {
            document.getElementById('splash-screen').classList.add('fade-out');
            setTimeout(() => {
                document.getElementById('splash-screen').style.display = 'none';
            }, 500);
        }, 2000);

    </script>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-black border-t border-amber-100 dark:border-amber-800 z-50">
        <div class="flex justify-around items-center py-2">
            <button class="flex flex-col items-center py-2 px-4 text-amber-600 dark:text-amber-400">
                <i data-lucide="home" class="w-5 h-5 mb-1"></i>
                <span class="text-xs font-medium">Home</span>
            </button>
            <button onclick="window.location.href='timer.html'" class="flex flex-col items-center py-2 px-4 text-slate-400 dark:text-amber-600 hover:text-amber-600 dark:hover:text-amber-400 transition-colors">
                <i data-lucide="timer" class="w-5 h-5 mb-1"></i>
                <span class="text-xs font-medium">Timer</span>
            </button>
            <button onclick="window.location.href='tracker.html'" class="flex flex-col items-center py-2 px-4 text-slate-400 dark:text-amber-600 hover:text-amber-600 dark:hover:text-amber-400 transition-colors">
                <i data-lucide="bar-chart-3" class="w-5 h-5 mb-1"></i>
                <span class="text-xs font-medium">Tracker</span>
            </button>
        </div>
    </nav>
</body>
</html>
