<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caffine - Offline Capable</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' stroke='%23d97706' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M18 8h1a4 4 0 0 1 0 8h-1'/%3E%3Cpath d='M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z'/%3E%3Cline x1='6' y1='1' x2='6' y2='4'/%3E%3Cline x1='10' y1='1' x2='10' y2='4'/%3E%3Cline x1='14' y1='1' x2='14' y2='4'/%3E%3C/svg%3E">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Tailwind Config -->
    <script>
        if (typeof tailwind === 'undefined') {
            console.warn('Tailwind CSS not loaded (offline).');
        } else {
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        animation: {
                            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                            'fadeIn': 'fadeIn 0.2s ease-out',
                            'progress': 'progress 3s linear'
                        },
                        keyframes: {
                            fadeIn: {
                                '0%': { opacity: '0', transform: 'scale(0.95)' },
                                '100%': { opacity: '1', transform: 'scale(1)' },
                            },
                            progress: {
                                '0%': { width: '0%' },
                                '100%': { width: '100%' },
                            }
                        },
                        colors: {
                            card: '#1a1a1a'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body {
            -webkit-tap-highlight-color: transparent;
            background-color: #fffbeb;
            font-family: system-ui, -apple-system, sans-serif;
        }
        .dark body { background-color: #000000; }
        * {
            transition-property: background-color, border-color, color, fill, stroke, width, opacity;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 300ms;
        }
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; transition: opacity 0.5s ease;
        }
        .dark #splash-screen { background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%); }
        #splash-screen.fade-out { opacity: 0; pointer-events: none; }
        #splash-logo {
            width: 120px; height: 120px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* Tracker Styles */
        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.03);
        }
        .dark .glass-header {
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 1px solid #f59e0b;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .soft-card {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }
        .dark .soft-card {
            background-color: #1a1a1a;
            box-shadow: none;
            border: 1px solid #f59e0b;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .progress-transition {
            transition: width 1.0s cubic-bezier(0.22, 1, 0.36, 1);
        }
    </style>
</head>
<body class="text-slate-800 dark:text-amber-300 font-sans pb-20 selection:bg-amber-400 selection:text-black transition-colors duration-500">

    <!-- Splash Screen -->
    <div id="splash-screen">
        <svg id="splash-logo" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-amber-600 dark:text-amber-400">
            <path d="M18 8h1a4 4 0 0 1 0 8h-1"></path>
            <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path>
            <line x1="6" y1="1" x2="6" y2="4"></line>
            <line x1="10" y1="1" x2="10" y2="4"></line>
            <line x1="14" y1="1" x2="14" y2="4"></line>
        </svg>
        <h1 class="text-2xl font-bold text-amber-600 dark:text-amber-400 mt-4">Caffine</h1>
        <p class="text-xs text-amber-800/60 dark:text-amber-400/60 mt-2 font-medium">Offline Ready</p>
    </div>

    <!-- App Container -->
    <div id="app" class="max-w-5xl mx-auto px-4 pt-6 md:px-12 md:pt-12">
        
        <!-- Header -->
        <header class="mb-6 flex flex-col gap-5 md:flex-row md:items-end justify-between">
            <div class="flex items-start justify-between w-full md:w-auto">
                <div>
                    <h1 class="text-3xl font-extrabold tracking-tight text-slate-900 dark:text-amber-300 flex items-center gap-3">
                         <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-600 dark:text-amber-400">
                            <path d="M18 8h1a4 4 0 0 1 0 8h-1"></path>
                            <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path>
                            <line x1="6" y1="1" x2="6" y2="4"></line>
                            <line x1="10" y1="1" x2="10" y2="4"></line>
                            <line x1="14" y1="1" x2="14" y2="4"></line>
                        </svg>
                        Caffine
                    </h1>
                    <div class="flex items-center gap-3 mt-1">
                        <p id="start-date-display" class="text-slate-700 dark:text-amber-200 text-sm font-medium">
                            Loading...
                        </p>
                        <div class="flex items-center gap-2 px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-900/50">
                            <div id="user-status-dot" class="w-2 h-2 rounded-full bg-slate-300 transition-colors"></div>
                            <span id="user-status-text" class="text-xs font-bold text-slate-500 dark:text-slate-400">Checking...</span>
                        </div>
                    </div>
                </div>
                <!-- Mobile Actions -->
                <div class="md:hidden flex gap-2">
                    <button id="theme-toggle-mobile" class="p-2.5 rounded-full bg-amber-100 dark:bg-amber-900 text-slate-600 dark:text-amber-300 active:scale-95 transition-transform">
                        <i data-lucide="moon" class="dark:hidden"></i>
                        <i data-lucide="sun" class="hidden dark:block"></i>
                    </button>
                    <button id="profile-btn-mobile" class="p-2.5 rounded-full bg-amber-100 dark:bg-amber-900 text-slate-600 dark:text-amber-300 active:scale-95 transition-transform">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    </button>
                </div>
            </div>

            <div class="flex flex-col-reverse md:flex-row md:items-center gap-4">
                <div id="duration-container" class="flex bg-amber-100 dark:bg-amber-900 p-1.5 rounded-xl overflow-x-auto w-full md:w-auto scrollbar-hide">
                    <!-- Buttons injected by JS -->
                </div>
                <div class="hidden md:flex gap-2">
                    <button id="theme-toggle-desktop" class="p-3 rounded-full hover:bg-amber-100 dark:hover:bg-amber-900 transition-colors text-slate-600 dark:text-amber-300">
                        <i data-lucide="moon" class="dark:hidden"></i>
                        <i data-lucide="sun" class="hidden dark:block"></i>
                    </button>
                    <button id="profile-btn" class="p-3 rounded-full hover:bg-amber-100 dark:hover:bg-amber-900 transition-colors text-slate-600 dark:text-amber-300">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Offline Banner -->
        <div id="offline-banner" class="hidden mb-6 p-3 bg-slate-800 text-white dark:bg-amber-900/40 dark:text-amber-200 rounded-lg text-sm font-medium flex items-center justify-center gap-2 animate-fadeIn">
            <i data-lucide="wifi-off" class="w-4 h-4"></i>
            <span>You are offline. Changes saved locally.</span>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4 mb-6 md:mb-8">
            <!-- Streak Card -->
            <div id="streak-card" class="col-span-2 md:col-span-1 flex flex-col p-4 rounded-2xl border border-amber-100 dark:border-amber-800 transition-all duration-500 relative overflow-hidden bg-amber-50 dark:bg-amber-950/20">
                <!-- Content Injected JS -->
            </div>

            <!-- Total Hours Card -->
            <div class="flex flex-col p-4 rounded-2xl border border-amber-100 dark:border-amber-800 bg-amber-50 dark:bg-amber-950/20">
                <div class="mb-2 text-amber-500"><i data-lucide="clock" size="18"></i></div>
                <span id="stat-total-hours" class="text-2xl md:text-3xl font-bold text-slate-800 dark:text-amber-300 tracking-tight">0h</span>
                <span class="text-[10px] md:text-xs text-slate-500 dark:text-amber-400 font-bold uppercase tracking-wider opacity-80">Total Hours</span>
            </div>

            <!-- Days Logged Card -->
            <div class="flex flex-col p-4 rounded-2xl border border-amber-100 dark:border-amber-800 bg-amber-50 dark:bg-amber-950/20">
                <div class="mb-2 text-amber-500"><i data-lucide="calendar" size="18"></i></div>
                <span id="stat-days-logged" class="text-2xl md:text-3xl font-bold text-slate-800 dark:text-amber-300 tracking-tight">0</span>
                <span class="text-[10px] md:text-xs text-slate-500 dark:text-amber-400 font-bold uppercase tracking-wider opacity-80">Days Logged</span>
            </div>
        </div>

        <!-- The Grid -->
        <div class="bg-white dark:bg-black p-4 md:p-8 rounded-[2rem] shadow-xl shadow-amber-200/50 dark:shadow-none border border-amber-100 dark:border-amber-800/50 relative overflow-hidden">
            <div class="absolute top-0 right-0 -mt-20 -mr-20 w-80 h-80 bg-amber-400/10 rounded-full blur-[100px] pointer-events-none"></div>
            <div id="grid-container" class="grid gap-1.5 md:gap-3 transition-all duration-500 relative z-10" style="grid-template-columns: repeat(auto-fill, minmax(38px, 1fr));">
                <!-- Blocks injected by JS -->
            </div>
            <!-- Legend -->
            <div class="mt-8 pt-6 border-t border-amber-100 dark:border-amber-800 flex overflow-x-auto pb-2 scrollbar-hide items-center md:justify-center gap-6 text-[10px] md:text-xs text-slate-500 dark:text-amber-400 font-semibold whitespace-nowrap">
                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-amber-100 dark:bg-amber-800"></div><span>0h</span></div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-yellow-300"></div><span>1-2h</span></div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-purple-400"></div><span>3-4h</span></div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-cyan-400"></div><span>5-6h</span></div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-green-500"></div><span>7-8h</span></div>
                <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-gradient-to-r from-pink-500 to-violet-600"></div><span>9h+</span></div>
            </div>
        </div>

        <div class="mt-6 text-center text-slate-400 dark:text-amber-500 text-xs font-medium md:hidden">
            Long press any block for details
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-md p-4">
        <div class="bg-white dark:bg-black w-full max-w-sm p-6 rounded-3xl shadow-2xl border border-amber-100 dark:border-amber-800">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-900 dark:text-amber-300">Profile</h3>
                <button id="close-profile" class="p-2 hover:bg-amber-100 dark:hover:bg-amber-800 rounded-full transition-colors">
                    <i data-lucide="x" class="text-slate-500 dark:text-amber-300 w-5 h-5"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div class="flex items-center gap-3 p-4 bg-amber-50 dark:bg-amber-950/20 rounded-xl">
                    <div class="w-12 h-12 rounded-full bg-amber-500 flex items-center justify-center text-white font-bold text-lg">
                        <i data-lucide="user" class="w-6 h-6"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-slate-500 dark:text-amber-400 font-medium">Account</p>
                        <p id="user-email" class="text-sm font-semibold text-slate-900 dark:text-amber-300 truncate">Guest / Offline</p>
                    </div>
                </div>
                
                <!-- Login Form -->
                <div id="auth-form" class="space-y-3 pt-2">
                    <input type="email" id="auth-email" placeholder="Email Address" class="w-full p-3 rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-white focus:ring-2 focus:ring-amber-400 outline-none transition-all text-sm" />
                    <input type="password" id="auth-password" placeholder="Password" class="w-full p-3 rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-white focus:ring-2 focus:ring-amber-400 outline-none transition-all text-sm" />
                    
                    <div class="flex gap-2 pt-1">
                         <button id="btn-signin" class="flex-1 p-3 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-bold transition-colors text-sm shadow-lg shadow-amber-500/20">Login</button>
                         <button id="btn-signup" class="flex-1 p-3 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-xl font-bold transition-colors text-sm">Sign Up</button>
                    </div>
                    <p id="auth-error" class="text-red-500 text-xs text-center hidden font-medium mt-2 bg-red-50 dark:bg-red-900/20 p-2 rounded-lg"></p>
                </div>

                <div id="logged-in-actions" class="hidden space-y-3">
                    <button id="btn-sync-timeline" class="w-full flex items-center justify-between p-4 bg-amber-50 dark:bg-amber-900/10 rounded-xl hover:bg-amber-100 dark:hover:bg-amber-900/30 transition-colors border border-amber-100 dark:border-amber-900/20">
                         <div class="flex items-center gap-3">
                            <div class="p-1.5 bg-amber-100 dark:bg-amber-900/50 rounded-lg text-amber-600 dark:text-amber-400">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            </div>
                            <div class="text-left">
                                <span class="block text-sm font-semibold text-slate-700 dark:text-amber-200">Sync Timeline</span>
                                <span class="block text-[10px] text-slate-400 dark:text-amber-500/60">Restore start date from history</span>
                            </div>
                        </div>
                    </button>

                    <button id="logout-btn" class="w-full flex items-center justify-between p-4 bg-red-50 dark:bg-red-950/20 rounded-xl hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors">
                        <div class="flex items-center gap-3">
                            <i data-lucide="log-out" class="w-5 h-5 text-red-600 dark:text-red-400"></i>
                            <span class="text-sm font-medium text-red-600 dark:text-red-400">Logout</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Popup -->
    <div id="popup-backdrop" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-md p-4 animate-fadeIn">
        <div class="bg-white dark:bg-black w-full max-w-xs p-6 rounded-3xl shadow-2xl border border-amber-100 dark:border-amber-800 transform transition-all scale-100 relative">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 id="popup-date" class="text-xl font-bold text-slate-900 dark:text-amber-300 tracking-tight">Date</h3>
                    <p id="popup-status" class="text-sm text-slate-500 dark:text-amber-300 font-medium">Status</p>
                </div>
                <button id="popup-close" class="p-2 hover:bg-amber-100 dark:hover:bg-amber-800 rounded-full transition-colors">
                    <i data-lucide="x" class="text-slate-500 dark:text-amber-300 w-5 h-5"></i>
                </button>
            </div>
            <div class="flex items-center gap-5 mb-6">
                <div id="popup-hours-box" class="relative w-16 h-16 rounded-2xl flex items-center justify-center text-3xl font-bold shadow-inner transition-colors duration-300">
                    <span id="popup-hours-val">0</span><span class="text-sm font-medium opacity-60 ml-0.5 mt-2">h</span>
                    <div id="popup-unlocked-dot" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-green-500 border-2 border-white dark:border-zinc-950 rounded-full"></div>
                </div>
                <div class="flex-1">
                    <div id="popup-text-desc" class="text-sm font-semibold text-slate-700 dark:text-amber-200">No Activity</div>
                    <div class="w-full bg-amber-100 dark:bg-amber-900 rounded-full h-2 mt-2 overflow-hidden">
                        <div id="popup-progress-bar" class="bg-amber-400 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <button id="btn-unlock" class="w-full flex items-center justify-center gap-2 text-xs font-semibold text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/10 py-3 rounded-xl border border-amber-100 dark:border-amber-900/20 hover:bg-amber-100 dark:hover:bg-amber-900/30 transition-colors">
                <i data-lucide="lock" class="w-3.5 h-3.5"></i>
                <span>Unlock to Edit Grid</span>
            </button>
            <div id="controls-unlocked" class="hidden flex items-center gap-2">
                <button id="btn-minus" class="flex-1 flex items-center justify-center py-3 rounded-xl bg-amber-100 dark:bg-amber-900 text-slate-600 dark:text-amber-300 hover:bg-amber-200 dark:hover:bg-amber-800 transition-colors active:scale-95"><i data-lucide="minus" class="w-4 h-4"></i></button>
                <button id="btn-plus" class="flex-1 flex items-center justify-center py-3 rounded-xl bg-amber-5 dark:bg-amber-900/30 text-amber-600 dark:text-amber-300 hover:bg-amber-100 dark:hover:bg-amber-900/50 transition-colors active:scale-95"><i data-lucide="plus" class="w-4 h-4"></i></button>
                <button id="btn-lock" class="px-4 py-3 rounded-xl bg-amber-100 dark:bg-amber-900 text-slate-400 dark:text-amber-400 hover:text-slate-600 dark:hover:text-amber-200 transition-colors"><i data-lucide="lock-open" class="w-4 h-4"></i></button>
            </div>
            <div id="msg-future" class="hidden text-xs text-center font-medium text-slate-400 dark:text-amber-500 py-3">Future dates cannot be edited yet.</div>
        </div>
    </div>

    <!-- Application Logic -->
    <script type="module">
        // Global variables used by the app
        let app, auth, db;
        let initializeApp, getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously;
        let getFirestore, doc, setDoc, onSnapshot, getDoc;
        let firebaseLoaded = false;
        let initialCloudSyncComplete = false; // Guard for data overwrite

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCYY2GQqS0tCXb7Oxw8AWXhpexq9e8VRUs",
            authDomain: "aspirehub-32863.firebaseapp.com",
            projectId: "aspirehub-32863",
            storageBucket: "aspirehub-32863.appspot.com",
            messagingSenderId: "686810111182",
            appId: "1:686810111182:web:4290b4b1b6e64934ec449f",
        };
        const appId = 'caffine-tracker-v1';

        // --- Core Init ---
        // We use dynamic imports to prevent the entire script from crashing if internet is down.
        async function initApp() {
            try {
                // Try importing Firebase
                const fbApp = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                const fbAuth = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                const fbStore = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                // Assign to global variables
                initializeApp = fbApp.initializeApp;
                getAuth = fbAuth.getAuth;
                signInWithEmailAndPassword = fbAuth.signInWithEmailAndPassword;
                createUserWithEmailAndPassword = fbAuth.createUserWithEmailAndPassword;
                signOut = fbAuth.signOut;
                onAuthStateChanged = fbAuth.onAuthStateChanged;
                signInAnonymously = fbAuth.signInAnonymously;
                getFirestore = fbStore.getFirestore;
                doc = fbStore.doc;
                setDoc = fbStore.setDoc;
                onSnapshot = fbStore.onSnapshot;
                getDoc = fbStore.getDoc;

                // Initialize
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                firebaseLoaded = true;

                // Setup Auth Listener
                setupAuthListener();

            } catch (error) {
                console.warn("Firebase failed to load (Offline). App running in local-only mode.");
                updateUserStatus('offline');
                if (document.getElementById('user-email')) document.getElementById('user-email').textContent = "Offline Mode";
            }

            // Always render local data
            renderAll();
            
            // Safe safe to remove splash
            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                if(splash) splash.classList.add('fade-out');
            }, 1000);
        }

        // --- Status UI ---
        const statusDot = document.getElementById('user-status-dot');
        const statusText = document.getElementById('user-status-text');
        const offlineBanner = document.getElementById('offline-banner');
        
        function updateUserStatus(status) {
            if (!statusDot || !statusText) return;
            if (status === 'offline') {
                statusDot.className = "w-2 h-2 rounded-full bg-slate-400";
                statusText.textContent = "Offline";
                if(offlineBanner) offlineBanner.classList.remove('hidden');
            } else if (status === 'syncing') {
                statusDot.className = "w-2 h-2 rounded-full bg-amber-500 animate-pulse";
                statusText.textContent = "Syncing...";
                if(offlineBanner) offlineBanner.classList.add('hidden');
            } else if (status === 'synced') {
                statusDot.className = "w-2 h-2 rounded-full bg-emerald-500";
                statusText.textContent = "Synced";
                if(offlineBanner) offlineBanner.classList.add('hidden');
            }
        }

        // --- State Management ---
        const localData = JSON.parse(localStorage.getItem('caffine_data') || '{}');
        // Offset for local date
        const offset = new Date().getTimezoneOffset() * 60000;
        const todayStr = (new Date(Date.now() - offset)).toISOString().split('T')[0];

        window.state = {
            user: null,
            history: localData.history || {}, 
            duration: localData.duration || 400,
            darkMode: localData.darkMode !== undefined ? localData.darkMode : false,
            startDateStr: localData.startDateStr || todayStr
        };

        let popupState = { isOpen: false, date: null, hours: 0, isLocked: true };

        // --- Repair Logic (New Feature) ---
        window.repairTimeline = function() {
            const dates = Object.keys(window.state.history).sort();
            if (dates.length === 0) {
                 alert("No history found to sync from.");
                 return;
            }

            const earliestHistory = dates[0];
            const currentStart = window.state.startDateStr;
            let updated = false;

            // If the earliest data point is BEFORE the current start date, move start date back.
            if (earliestHistory < currentStart) {
                console.log(`Repairing timeline: Moving start from ${currentStart} to ${earliestHistory}`);
                window.state.startDateStr = earliestHistory;
                updated = true;
            }

            if (updated) {
                window.saveData();
                renderAll();
                alert(`Timeline synced! Start date restored to ${earliestHistory}.`);
            } else {
                alert("Timeline is already in sync with your history.");
            }
        };

        // --- Core Sync Logic ---
        window.saveData = async () => {
            // 1. Always save to LocalStorage (Immediate UI update)
            localStorage.setItem('caffine_data', JSON.stringify({
                history: window.state.history,
                duration: window.state.duration,
                darkMode: window.state.darkMode,
                startDateStr: window.state.startDateStr
            }));
            
            // 2. Try Cloud Sync if possible
            if (firebaseLoaded && navigator.onLine && window.state.user) {
                // CRITICAL FIX: Do NOT overwrite cloud data if we haven't finished the initial sync
                // This prevents a new device (initialized with Today) from overwriting an existing account's start date
                if (!initialCloudSyncComplete) {
                    console.log("Skipping cloud save: Initial sync not complete");
                    return;
                }

                updateUserStatus('syncing');
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'users', window.state.user.uid, 'data', 'main'), {
                        history: window.state.history,
                        duration: window.state.duration,
                        darkMode: window.state.darkMode,
                        startDateStr: window.state.startDateStr,
                        lastUpdated: new Date().toISOString()
                    }, { merge: true });
                    
                    updateUserStatus('synced');
                    localStorage.removeItem('caffine_needs_sync');
                } catch (e) {
                    console.error("Cloud save failed:", e);
                    markAsDirty();
                }
            } else {
                markAsDirty();
            }
            renderAll(); // Re-render to update UI
        };

        function markAsDirty() {
            updateUserStatus('offline');
            localStorage.setItem('caffine_needs_sync', 'true');
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                window.state.user = user;
                const authForm = document.getElementById('auth-form');
                const loggedInActions = document.getElementById('logged-in-actions');
                const userEmail = document.getElementById('user-email');

                if (user) {
                    userEmail.textContent = user.isAnonymous ? "Guest (Synced)" : user.email;
                    authForm.classList.add('hidden');
                    loggedInActions.classList.remove('hidden');

                    // Cloud Sync Strategy
                    if (navigator.onLine) {
                        updateUserStatus('syncing');
                        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'main');
                        
                        try {
                            // Initial Fetch
                            const snap = await getDoc(docRef);
                            if (snap.exists()) {
                                const cloudData = snap.data();
                                // Merge cloud data into local
                                window.state.history = { ...window.state.history, ...cloudData.history };
                                
                                // FORCE SYNC START DATE
                                if (cloudData.startDateStr) {
                                    window.state.startDateStr = cloudData.startDateStr;
                                } 
                                
                                // AUTOMATIC REPAIR on LOGIN
                                // Check if history has dates older than the start date and fix immediately
                                const historyDates = Object.keys(window.state.history).sort();
                                if (historyDates.length > 0 && historyDates[0] < window.state.startDateStr) {
                                    console.log(`Auto-repairing start date from ${window.state.startDateStr} to ${historyDates[0]}`);
                                    window.state.startDateStr = historyDates[0];
                                }
                                
                                if (cloudData.duration) window.state.duration = cloudData.duration;
                                if (cloudData.darkMode !== undefined) window.state.darkMode = cloudData.darkMode;
                                
                                // Mark sync as complete BEFORE saving
                                initialCloudSyncComplete = true;
                                window.saveData(); 
                            } else {
                                // New User in Cloud
                                initialCloudSyncComplete = true;
                                window.saveData(); // Push local to cloud
                            }

                            // Listener
                            onSnapshot(docRef, (snapshot) => {
                                if (!snapshot.exists()) return;
                                const cloudData = snapshot.data();
                                const needsSync = localStorage.getItem('caffine_needs_sync') === 'true';
                                // Only overwrite local if we aren't dirty (pending save)
                                if (!needsSync) {
                                    window.state.history = { ...window.state.history, ...cloudData.history };
                                    
                                    // Live update start date
                                    if (cloudData.startDateStr) {
                                        window.state.startDateStr = cloudData.startDateStr;
                                    }
                                    if (cloudData.duration) window.state.duration = cloudData.duration;
                                    
                                    renderAll();
                                }
                            });
                        } catch(e) {
                            console.log("Error fetching cloud data", e);
                            updateUserStatus('offline');
                            // If fetch failed, we allow local edits to proceed but stay in 'offline' state
                            initialCloudSyncComplete = true; 
                        }
                    } else {
                        initialCloudSyncComplete = true; 
                    }

                    // Setup tracker sync
                    setupTrackerSync(user.uid);

                } else {
                    userEmail.textContent = "Guest / Offline";
                    authForm.classList.remove('hidden');
                    loggedInActions.classList.add('hidden');
                    updateUserStatus('offline');
                    initialCloudSyncComplete = false;
                    
                    updateTrackerStatus('offline');
                    // Clean up tracker listener
                    if (trackerSyncListener) {
                        trackerSyncListener();
                        trackerSyncListener = null;
                    }
                }
                renderAll();
            });
        }

        // --- Network Listeners ---
        window.addEventListener('online', () => {
            console.log("Network restored");
            if(firebaseLoaded && window.state.user) {
                // Sync main data
                const needsSync = localStorage.getItem('caffine_needs_sync') === 'true';
                if (needsSync) {
                    console.log("Syncing pending changes...");
                    window.saveData();
                } else {
                    updateUserStatus('synced');
                }
                
                // Sync tracker data
                const trackerNeedsSync = localStorage.getItem('tracker_needs_sync') === 'true';
                if (trackerNeedsSync) {
                    console.log("Syncing pending tracker changes...");
                    syncTrackerToFirebase();
                } else if (!trackerSyncListener) {
                    // Re-establish tracker sync if not already active
                    setupTrackerSync(window.state.user.uid);
                }
            }
        });

        window.addEventListener('offline', () => {
            updateUserStatus('offline');
            updateTrackerStatus('offline');
        });

        // --- Render Logic ---
        function renderAll() {
            applyTheme();
            renderHeader();
            renderStats();
            renderGrid();
            if (popupState.isOpen) updatePopupContent();
            
            // Safe Icon Rendering
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        function applyTheme() {
            const html = document.documentElement;
            const body = document.body;
            if (window.state.darkMode) {
                html.classList.add('dark');
                body.classList.add('bg-black');
                body.classList.remove('bg-slate-50');
            } else {
                html.classList.remove('dark');
                body.classList.remove('bg-black');
                body.classList.add('bg-slate-50');
            }
        }

        function renderHeader() {
            const dateEl = document.getElementById('start-date-display');
            if (window.state.startDateStr) {
                const [y, m, d] = window.state.startDateStr.split('-').map(Number);
                const startDate = new Date(y, m-1, d);
                dateEl.textContent = `Started ${new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric', year: 'numeric' }).format(startDate)}`;
            }

            const container = document.getElementById('duration-container');
            container.innerHTML = '';
            [30, 60, 90, 400].forEach(d => {
                const btn = document.createElement('button');
                btn.className = `flex-1 md:flex-none px-4 py-2 text-xs md:text-sm font-bold rounded-lg whitespace-nowrap transition-all ${
                    window.state.duration === d 
                    ? 'bg-white dark:bg-amber-800 shadow-sm text-amber-600 dark:text-white' 
                    : 'text-slate-500 dark:text-amber-400 hover:text-slate-700 dark:hover:text-amber-200'
                }`;
                btn.textContent = `${d} Days`;
                btn.onclick = () => {
                    window.state.duration = d;
                    window.saveData();
                };
                container.appendChild(btn);
            });
        }

        function calculateStreaks() {
            const offset = new Date().getTimezoneOffset() * 60000;
            const todayStr = (new Date(Date.now() - offset)).toISOString().split('T')[0];
            let checkDate = new Date();
            
            // If today is 0, check yesterday to allow streak to hold
            if ((window.state.history[todayStr] || 0) === 0) {
                checkDate.setDate(checkDate.getDate() - 1);
            }
            
            const runCheck = (threshold) => {
                let count = 0;
                let d = new Date(checkDate);
                for (let i=0; i<365; i++) {
                    const offset = d.getTimezoneOffset() * 60000;
                    const localISOTime = (new Date(d - offset)).toISOString().slice(0, -1);
                    const localDS = localISOTime.split('T')[0];

                    if ((window.state.history[localDS] || 0) >= threshold) {
                        count++;
                        d.setDate(d.getDate() - 1);
                    } else {
                        break;
                    }
                }
                return count;
            };
            return { any: runCheck(1), medium: runCheck(5), deep: runCheck(8) };
        }

        let streakInterval, streakIndex = 0;
        function renderStats() {
            const totalHours = Object.values(window.state.history).reduce((a,b) => a+b, 0);
            const daysLogged = Object.values(window.state.history).filter(h => h > 0).length;
            
            document.getElementById('stat-total-hours').textContent = `${totalHours}h`;
            document.getElementById('stat-days-logged').textContent = daysLogged;

            if (!streakInterval) {
                renderStreakCard();
                streakInterval = setInterval(() => {
                    streakIndex = (streakIndex + 1) % 3;
                    renderStreakCard();
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }, 3000);
            } else {
                renderStreakCard();
            }
        }

        function renderStreakCard() {
            const streaks = calculateStreaks();
            const types = [
                { label: "Activity Streak", value: streaks.any, icon: "flame", color: "text-orange-500", bg: "bg-orange-50 dark:bg-orange-950/20" },
                { label: "Deep Work Streak", value: streaks.medium, icon: "zap", color: "text-purple-500", bg: "bg-purple-50 dark:bg-purple-950/20" },
                { label: "Mastery Streak", value: streaks.deep, icon: "trophy", color: "text-indigo-500", bg: "bg-indigo-50 dark:bg-indigo-950/20" }
            ];
            const current = types[streakIndex];
            const card = document.getElementById('streak-card');
            card.className = `col-span-2 md:col-span-1 flex flex-col p-4 rounded-2xl border border-slate-100 dark:border-zinc-800 transition-all duration-500 relative overflow-hidden ${current.bg}`;
            card.innerHTML = `
                <div class="mb-2 ${current.color} flex items-center justify-between">
                    <i data-lucide="${current.icon}" width="18" height="18"></i>
                    <div class="w-8 h-1 bg-black/5 dark:bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full bg-current opacity-50 animate-progress"></div>
                    </div>
                </div>
                <div class="animate-fadeIn">
                    <span class="text-3xl font-bold text-slate-800 dark:text-white block tracking-tight">
                        ${current.value} <span class="text-sm font-medium text-slate-500 dark:text-zinc-500">days</span>
                    </span>
                    <span class="text-[10px] md:text-xs text-slate-500 dark:text-zinc-400 font-bold uppercase tracking-wider opacity-80">${current.label}</span>
                </div>
            `;
        }

        function renderGrid() {
            const grid = document.getElementById('grid-container');
            grid.innerHTML = '';
            const colSize = window.state.duration >= 365 ? '22px' : '38px';
            grid.style.gridTemplateColumns = `repeat(auto-fill, minmax(${colSize}, 1fr))`;

            if (!window.state.startDateStr) return;
            const [y, m, d] = window.state.startDateStr.split('-').map(Number);
            const start = new Date(y, m-1, d);
            const today = new Date();
            // Local ISO helper
            const getLocalDS = (date) => {
                 const offset = date.getTimezoneOffset() * 60000;
                 return (new Date(date.getTime() - offset)).toISOString().split('T')[0];
            };
            const offset = today.getTimezoneOffset() * 60000;
            const todayIso = (new Date(today.getTime() - offset)).toISOString().split('T')[0];

            for(let i=0; i<window.state.duration; i++) {
                const date = new Date(start);
                date.setDate(start.getDate() + i);
                const iso = getLocalDS(date);
                const hours = window.state.history[iso] || 0;
                
                const isToday = iso === todayIso;
                const isFuture = date > today && !isToday;

                let colorClass = "bg-amber-100 dark:bg-amber-900 border-amber-200 dark:border-amber-800 text-transparent";
                if (hours > 0) {
                     if (hours <= 2) colorClass = "bg-yellow-300 border-yellow-400 text-yellow-900";
                     else if (hours <= 4) colorClass = "bg-purple-400 border-purple-500 text-white";
                     else if (hours <= 6) colorClass = "bg-cyan-400 border-cyan-500 text-cyan-900";
                     else if (hours <= 8) colorClass = "bg-green-500 border-green-600 text-white";
                     else if (hours <= 10) colorClass = "bg-blue-500 border-blue-600 text-white";
                     else if (hours <= 12) colorClass = "bg-indigo-600 border-indigo-700 text-white";
                     else colorClass = "bg-gradient-to-r from-pink-500 to-violet-600 border-pink-600 text-white";
                }

                const btn = document.createElement('button');
                btn.className = `group relative w-full aspect-square rounded-md md:rounded-lg border-b-[3px] md:border-b-4 ease-out touch-manipulation flex items-center justify-center font-bold text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-400 dark:focus:ring-offset-black ${hours === 0 ? 'translate-y-0' : '-translate-y-[2px]'} ${colorClass} ${isToday ? 'ring-2 ring-offset-2 ring-amber-300 dark:ring-amber-400 animate-pulse-slow z-10' : ''} ${isFuture ? 'opacity-30 cursor-not-allowed' : ''} active:border-b-0 active:translate-y-[2px]`;

                if (!isToday && hours === 0) {
                    btn.innerHTML = `<i data-lucide="lock" width="8" height="8" class="text-amber-300 dark:text-amber-700 absolute"></i>`;
                } else if (hours > 0) {
                    btn.textContent = hours;
                }

                if (!isFuture) {
                    const handleInteraction = () => {
                        if (isToday) {
                             let next = hours === 0 ? 2 : (hours < 14 ? hours + 1 : 0);
                             window.state.history[iso] = next;
                             window.saveData();
                        } else {
                            openPopup(date, hours);
                        }
                    };

                    let longPressTimer;
                    const startPress = () => { longPressTimer = setTimeout(() => { openPopup(date, hours); longPressTimer = null; }, 600); };
                    const cancelPress = () => { if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; } };

                    btn.addEventListener('mousedown', startPress);
                    btn.addEventListener('touchstart', startPress, {passive: true});
                    btn.addEventListener('mouseup', () => { if(longPressTimer) { clearTimeout(longPressTimer); handleInteraction(); } });
                    btn.addEventListener('touchend', (e) => { 
                        if(longPressTimer) { 
                            clearTimeout(longPressTimer); 
                            e.preventDefault(); 
                            handleInteraction(); 
                        } 
                    });
                    btn.addEventListener('mouseleave', cancelPress);
                    btn.addEventListener('touchmove', cancelPress);
                } else {
                     btn.onclick = () => openPopup(date, hours);
                }
                grid.appendChild(btn);
            }
        }

        // --- Popup Logic ---
        function openPopup(date, hours) {
            const offset = new Date().getTimezoneOffset() * 60000;
            const todayIso = (new Date(Date.now() - offset)).toISOString().split('T')[0];
            const dateIso = (new Date(date.getTime() - offset)).toISOString().split('T')[0];

            popupState = {
                isOpen: true,
                date: date,
                hours: hours,
                isLocked: dateIso !== todayIso
            };
            updatePopupContent();
            document.getElementById('popup-backdrop').classList.remove('hidden');
        }

        function updatePopupContent() {
            const { date, hours, isLocked } = popupState;
             const offset = new Date().getTimezoneOffset() * 60000;
             const todayIso = (new Date(Date.now() - offset)).toISOString().split('T')[0];
             const dateIso = (new Date(date.getTime() - offset)).toISOString().split('T')[0];
             const isToday = dateIso === todayIso;
             const isFuture = date > new Date() && !isToday;

            document.getElementById('popup-date').textContent = new Intl.DateTimeFormat('en-US', {weekday:'short', month:'short', day:'numeric'}).format(date);
            document.getElementById('popup-status').textContent = isToday ? "Today" : isFuture ? "Future" : "History";
            
            const hoursVal = document.getElementById('popup-hours-val');
            hoursVal.textContent = hours;
            const progress = document.getElementById('popup-progress-bar');
            progress.style.width = `${Math.min((hours / 14) * 100, 100)}%`;

            // Controls visibility
            document.getElementById('btn-unlock').classList.toggle('hidden', !isLocked || isFuture);
            document.getElementById('controls-unlocked').classList.toggle('hidden', isLocked || isFuture);
            document.getElementById('msg-future').classList.toggle('hidden', !isFuture);
            document.getElementById('popup-unlocked-dot').classList.toggle('hidden', isLocked);
            
            // Text Desc
            const textDesc = document.getElementById('popup-text-desc');
            const box = document.getElementById('popup-hours-box');
            
            // Reset box classes to base then add specific
            box.className = "relative w-16 h-16 rounded-2xl flex items-center justify-center text-3xl font-bold shadow-inner transition-colors duration-300";
            
            if (hours === 0) { box.classList.add('bg-amber-100','dark:bg-amber-900','text-amber-400'); textDesc.textContent = "No Activity"; }
            else if (hours <= 4) { box.classList.add('bg-purple-400','text-white'); textDesc.textContent = "Getting Started"; }
            else if (hours <= 8) { box.classList.add('bg-green-500','text-white'); textDesc.textContent = "Solid Progress"; }
            else { box.classList.add('bg-indigo-600','text-white'); textDesc.textContent = "Deep Focus"; }
        }

        // --- Interaction Handlers ---
        document.getElementById('popup-close').onclick = () => { popupState.isOpen = false; document.getElementById('popup-backdrop').classList.add('hidden'); };
        document.getElementById('btn-unlock').onclick = () => { popupState.isLocked = false; updatePopupContent(); };
        document.getElementById('btn-lock').onclick = () => { popupState.isLocked = true; updatePopupContent(); };
        
        const adjustHours = (d) => {
            const newH = Math.max(0, Math.min(14, popupState.hours + d));
            popupState.hours = newH;
            const offset = popupState.date.getTimezoneOffset() * 60000;
            const iso = (new Date(popupState.date.getTime() - offset)).toISOString().split('T')[0];
            window.state.history[iso] = newH;
            window.saveData();
            updatePopupContent();
        };
        document.getElementById('btn-minus').onclick = () => adjustHours(-1);
        document.getElementById('btn-plus').onclick = () => adjustHours(1);

        // Theme
        const toggleTheme = () => { window.state.darkMode = !window.state.darkMode; window.saveData(); };
        document.getElementById('theme-toggle-mobile').onclick = toggleTheme;
        document.getElementById('theme-toggle-desktop').onclick = toggleTheme;

        // Profile
        const profileModal = document.getElementById('profile-modal');
        const openProfile = () => { profileModal.classList.remove('hidden'); if (typeof lucide !== 'undefined') lucide.createIcons(); };
        document.getElementById('profile-btn').onclick = openProfile;
        document.getElementById('profile-btn-mobile').onclick = openProfile;
        document.getElementById('close-profile').onclick = () => {
            profileModal.classList.add('hidden');
            // Clear errors on close
            document.getElementById('auth-error').classList.add('hidden');
        };
        
        // --- Auth Actions ---

        function getAuthData() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error');
            errorEl.classList.add('hidden');
            
            if (!email || !password) {
                errorEl.textContent = "Please enter both email and password";
                errorEl.classList.remove('hidden');
                return null;
            }
            return { email, password, errorEl };
        }

        document.getElementById('btn-signin').onclick = async () => {
            if (!firebaseLoaded) { alert("Offline: Cannot login."); return; }
            const data = getAuthData();
            if (!data) return;

            try {
                await signInWithEmailAndPassword(auth, data.email, data.password);
                profileModal.classList.add('hidden');
                // Clear inputs
                document.getElementById('auth-email').value = '';
                document.getElementById('auth-password').value = '';
            } catch(e) {
                data.errorEl.textContent = "Login Failed: " + e.message.replace('Firebase: ', '');
                data.errorEl.classList.remove('hidden');
            }
        };

        document.getElementById('btn-signup').onclick = async () => {
             if (!firebaseLoaded) { alert("Offline: Cannot sign up."); return; }
             const data = getAuthData();
             if (!data) return;

             try {
                 await createUserWithEmailAndPassword(auth, data.email, data.password);
                 profileModal.classList.add('hidden');
                 // Clear inputs
                 document.getElementById('auth-email').value = '';
                 document.getElementById('auth-password').value = '';
             } catch(e) {
                 data.errorEl.textContent = "Sign Up Failed: " + e.message.replace('Firebase: ', '');
                 data.errorEl.classList.remove('hidden');
             }
        };

        document.getElementById('btn-sync-timeline').onclick = () => {
             if(window.repairTimeline) window.repairTimeline();
        };

        document.getElementById('logout-btn').onclick = async () => {
            if (firebaseLoaded) {
                await signOut(auth);
                // Clear inputs
                document.getElementById('auth-email').value = '';
                document.getElementById('auth-password').value = '';
            }
        };

        // Start App
        initApp();

        // --- Tracker Functionality ---
        const defaultTrackerData = {
            physics: [
                { name: "Units and Dimensions", theory: false, questions: false },
                { name: "Vectors", theory: false, questions: false },
                { name: "Kinematics", theory: false, questions: false },
                { name: "Newton's Laws of Motion", theory: false, questions: false },
                { name: "Friction", theory: false, questions: false },
                { name: "Work, Energy and Power", theory: false, questions: false },
                { name: "Centre of Mass", theory: false, questions: false },
                { name: "Rotation  MOI & Torque", theory: false, questions: false }
            ],
            chemistry: [
                { name: "Mole Concept", desc: "Basic calculation", theory: false, questions: false },
                { name: "Atomic Structure", desc: "Basics", theory: false, questions: false },
                { name: "States of Matter", desc: "Ideal Gas Eq", theory: false, questions: false },
                { name: "Periodic Table & Bonding", desc: "Must for Organic", theory: false, questions: false },
                { name: "Thermodynamics", desc: "Gibbs Free Energy", theory: false, questions: false },
                { name: "Ionic Equilibrium", desc: "pH & Solubility", theory: false, questions: false },
                { name: "Redox Reactions", desc: "Balancing", theory: false, questions: false }
            ],
            math: [
                { name: "Basic Logarithms", theory: false, questions: false },
                { name: "Quadratic Equations", theory: false, questions: false },
                { name: "Trigonometry", theory: false, questions: false },
                { name: "Permutations & Combinations", desc: "Probability Basis", theory: false, questions: false },
                { name: "Coordinate Geometry", desc: "Line & Circle", theory: false, questions: false }
            ]
        };

        let trackerData = JSON.parse(localStorage.getItem('syllabusTrackerData')) || JSON.parse(JSON.stringify(defaultTrackerData));
        let trackerSyncListener = null;

        function saveTrackerData() {
            localStorage.setItem('syllabusTrackerData', JSON.stringify(trackerData));
            
            if (firebaseLoaded && navigator.onLine && window.state.user) {
                updateTrackerStatus('syncing');
                syncTrackerToFirebase();
            } else {
                updateTrackerStatus('offline');
                localStorage.setItem('tracker_needs_sync', 'true');
            }
        }

        async function syncTrackerToFirebase() {
            if (!firebaseLoaded || !navigator.onLine || !window.state.user) return;
            
            try {
                await setDoc(doc(db, 'artifacts', 'syllabus-tracker-v1', 'users', window.state.user.uid, 'data', 'syllabus'), {
                    ...trackerData,
                    lastUpdated: new Date().toISOString()
                }, { merge: true });
                
                updateTrackerStatus('synced');
                localStorage.removeItem('tracker_needs_sync');
            } catch (e) {
                console.error("Tracker sync error", e);
                updateTrackerStatus('offline');
                localStorage.setItem('tracker_needs_sync', 'true');
            }
        }

        function updateTrackerStatus(status) {
            const dot = document.getElementById('tracker-sync-status-dot');
            const text = document.getElementById('tracker-sync-status-text');
            if (!dot || !text) return;
            
            if (status === 'offline') {
                dot.className = "w-1.5 h-1.5 rounded-full bg-slate-400";
                text.textContent = "Offline";
            } else if (status === 'syncing') {
                dot.className = "w-1.5 h-1.5 rounded-full bg-amber-500 animate-pulse";
                text.textContent = "Syncing";
            } else if (status === 'synced') {
                dot.className = "w-1.5 h-1.5 rounded-full bg-emerald-500";
                text.textContent = "Synced";
            }
        }

        function setupTrackerSync(userId) {
            if (!firebaseLoaded || !navigator.onLine) return;
            
            const docRef = doc(db, 'artifacts', 'syllabus-tracker-v1', 'users', userId, 'data', 'syllabus');
            
            // Initial fetch and merge
            getDoc(docRef).then((snap) => {
                if (snap.exists()) {
                    const cloudData = snap.data();
                    // Merge cloud data with local data
                    Object.keys(defaultTrackerData).forEach(subject => {
                        if (cloudData[subject]) {
                            trackerData[subject] = cloudData[subject];
                        }
                    });
                    saveTrackerData();
                    if (document.getElementById('tracker-view') && !document.getElementById('tracker-view').classList.contains('hidden')) {
                        initTracker();
                    }
                } else {
                    // Push local data to cloud
                    syncTrackerToFirebase();
                }
            }).catch((e) => {
                console.error("Error fetching tracker data:", e);
                updateTrackerStatus('offline');
            });

            // Real-time listener
            trackerSyncListener = onSnapshot(docRef, (snapshot) => {
                if (!snapshot.exists()) return;
                
                const cloudData = snapshot.data();
                const needsSync = localStorage.getItem('tracker_needs_sync') === 'true';
                
                // Only overwrite local if we don't have pending changes
                if (!needsSync) {
                    Object.keys(defaultTrackerData).forEach(subject => {
                        if (cloudData[subject]) {
                            trackerData[subject] = cloudData[subject];
                        }
                    });
                    localStorage.setItem('syllabusTrackerData', JSON.stringify(trackerData));
                    if (document.getElementById('tracker-view') && !document.getElementById('tracker-view').classList.contains('hidden')) {
                        initTracker();
                    }
                }
                updateTrackerStatus('synced');
            }, (error) => {
                console.error("Tracker sync error:", error);
                updateTrackerStatus('offline');
            });
        }

        function renderTrackerList(subject, listId) {
            const container = document.getElementById(listId);
            container.innerHTML = '';

            trackerData[subject].forEach((chapter, index) => {
                const isDone = chapter.theory && chapter.questions;
                const item = document.createElement('div');
                item.className = `p-3 rounded-xl transition-all duration-200 hover:bg-slate-50 dark:hover:bg-white/5 flex flex-row items-center justify-between gap-3 group`;
                
                item.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <h4 class="font-medium text-[13px] md:text-[15px] text-slate-700 dark:text-gray-300 ${isDone ? 'line-through text-slate-400 dark:text-gray-600' : ''} transition-all truncate">${chapter.name}</h4>
                        ${chapter.desc ? `<p class="text-[9px] md:text-[10px] uppercase tracking-wide text-slate-400 dark:text-gray-600 mt-0.5 truncate">${chapter.desc}</p>` : ''}
                    </div>
                    <div class="flex items-center gap-2 md:gap-3 shrink-0">
                        <label class="cursor-pointer flex items-center gap-1.5 md:gap-2 group/check p-1">
                            <span class="text-[8px] md:text-[9px] font-bold uppercase tracking-widest text-slate-300 dark:text-gray-600 group-hover/check:text-amber-600 transition-colors">Theory</span>
                            <div class="relative w-4 h-4 md:w-5 md:h-5">
                                <input type="checkbox" class="hidden" onchange="updateTrackerStatus('${subject}', ${index}, 'theory')" ${chapter.theory ? 'checked' : ''}>
                                <div class="w-full h-full border border-slate-300 dark:border-gray-700 rounded-md flex items-center justify-center text-white transition-all shadow-sm group-hover/check:border-amber-600 dark:bg-white/5 ${chapter.theory ? 'bg-amber-600 border-amber-600' : ''}">
                                    <svg class="w-2.5 h-2.5 md:w-3 md:h-3 transition-all duration-200 ${chapter.theory ? 'opacity-100' : 'opacity-0'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                </div>
                            </div>
                        </label>
                        <label class="cursor-pointer flex items-center gap-1.5 md:gap-2 group/check p-1">
                            <span class="text-[8px] md:text-[9px] font-bold uppercase tracking-widest text-slate-300 dark:text-gray-600 group-hover/check:text-amber-600 transition-colors">Prob</span>
                            <div class="relative w-4 h-4 md:w-5 md:h-5">
                                <input type="checkbox" class="hidden" onchange="updateTrackerStatus('${subject}', ${index}, 'questions')" ${chapter.questions ? 'checked' : ''}>
                                <div class="w-full h-full border border-slate-300 dark:border-gray-700 rounded-md flex items-center justify-center text-white transition-all shadow-sm group-hover/check:border-amber-600 dark:bg-white/5 ${chapter.questions ? 'bg-amber-600 border-amber-600' : ''}">
                                    <svg class="w-2.5 h-2.5 md:w-3 md:h-3 transition-all duration-200 ${chapter.questions ? 'opacity-100' : 'opacity-0'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                </div>
                            </div>
                        </label>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        window.updateTrackerStatus = function(subject, index, type) {
            trackerData[subject][index][type] = !trackerData[subject][index][type];
            saveTrackerData();
            calculateTrackerStats();
            renderTrackerList(subject, `tracker-${subject}-list`);
        }

        function calculateTrackerStats() {
            let totalTasks = 0;
            let completedTasks = 0;
            const subjects = ['physics', 'chemistry', 'math'];
            const stats = {};

            subjects.forEach(sub => {
                let subTotal = trackerData[sub].length * 2;
                let subDone = 0;
                
                trackerData[sub].forEach(ch => {
                    if(ch.theory) subDone++;
                    if(ch.questions) subDone++;
                });

                stats[sub] = { total: subTotal, done: subDone, percent: subTotal === 0 ? 0 : Math.round((subDone/subTotal)*100) };
                totalTasks += subTotal;
                completedTasks += subDone;

                document.getElementById(`tracker-${sub}-bar`).style.width = `${stats[sub].percent}%`;
                document.getElementById(`tracker-${sub}-text`).innerText = `${stats[sub].percent}%`;
            });

            const globalPercent = totalTasks === 0 ? 0 : Math.round((completedTasks / totalTasks) * 100);
            document.getElementById('tracker-global-progress').style.width = `${globalPercent}%`;
            document.getElementById('tracker-global-percentage').innerText = `${globalPercent}%`;
            document.getElementById('tracker-total-tasks-done').innerText = `${completedTasks}/${totalTasks}`;

            // Rank Logic
            const rankEl = document.getElementById('tracker-user-rank');
            if(globalPercent === 0) rankEl.innerText = "Robin";
            else if(globalPercent < 25) rankEl.innerText = "Nightwing";
            else if(globalPercent < 50) rankEl.innerText = "Red Hood";
            else if(globalPercent < 75) rankEl.innerText = "Batman";
            else if(globalPercent < 100) rankEl.innerText = "Dark Knight";
            else rankEl.innerText = "Justice League";

            // Focus Logic
            let minPercent = 100;
            let lagSubject = "Balanced";
            subjects.forEach(sub => {
                if(stats[sub].percent < minPercent) {
                    minPercent = stats[sub].percent;
                    lagSubject = sub.charAt(0).toUpperCase() + sub.slice(1);
                }
            });
            
            if(stats.physics.percent === stats.chemistry.percent && stats.chemistry.percent === stats.math.percent && stats.math.percent > 0) {
                lagSubject = "Consistent";
            }
            if(globalPercent === 100) lagSubject = "Gotham Protected";

            document.getElementById('tracker-focus-area').innerText = lagSubject;
        }

        function initTracker() {
            renderTrackerList('physics', 'tracker-physics-list');
            renderTrackerList('chemistry', 'tracker-chemistry-list');
            renderTrackerList('math', 'tracker-math-list');
            calculateTrackerStats();
        }

        // Navigation Logic
        document.getElementById('nav-home').onclick = () => {
            document.getElementById('tracker-view').classList.add('hidden');
            document.getElementById('planner-view').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('nav-home').className = "flex flex-col items-center py-2 px-4 text-amber-600 dark:text-amber-400";
            document.getElementById('nav-tracker').className = "flex flex-col items-center py-2 px-4 text-slate-400 dark:text-amber-800 hover:text-amber-600 dark:hover:text-amber-400 transition-colors";
            document.getElementById('nav-planner').className = "flex flex-col items-center py-2 px-4 text-slate-400 dark:text-amber-800 hover:text-amber-600 dark:hover:text-amber-400 transition-colors";
        };

        document.getElementById('nav-tracker').onclick = () => {
            document.getElementById('tracker-view').classList.remove('hidden');
            document.getElementById('planner-view').classList.add('hidden');
            document.getElementById('app').classList.add('hidden');
            document.getElementById('nav-tracker').className = "flex flex-col items-center py-2 px-4 text-amber-600 dark:text-amber-400";
            document.getElementById('nav-home').className = "flex flex-col items-center py-2 px-4 text-slate-400 dark:text-amber-800 hover:text-amber-600 dark:hover:text-amber-400 transition-colors";
            document.getElementById('nav-planner').className = "flex flex-col items-center py-2 px-4 text-slate-400 dark:text-amber-800 hover:text-amber-600 dark:hover:text-amber-400 transition-colors";
            initTracker();
        };

        document.getElementById('nav-planner').onclick = () => {
            document.getElementById('planner-view').classList.remove('hidden');
            document.getElementById('tracker-view').classList.add('hidden');
            document.getElementById('app').classList.add('hidden');
            document.getElementById('nav-planner').className = "flex flex-col items-center py-2 px-4 text-amber-600 dark:text-amber-400";
            document.getElementById('nav-home').className = "flex flex-col items-center py-2 px-4 text-slate-400 dark:text-amber-800 hover:text-amber-600 dark:hover:text-amber-400 transition-colors";
            document.getElementById('nav-tracker').className = "flex flex-col items-center py-2 px-4 text-slate-400 dark:text-amber-800 hover:text-amber-600 dark:hover:text-amber-400 transition-colors";
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

    </script>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-black border-t border-amber-100 dark:border-amber-800 z-40">
        <div class="flex justify-around items-center py-2">
            <button id="nav-home" class="flex flex-col items-center py-2 px-4 text-amber-600 dark:text-amber-400">
                <i data-lucide="home" class="w-5 h-5 mb-1"></i>
                <span class="text-xs font-medium">Home</span>
            </button>
            <button id="nav-tracker" class="flex flex-col items-center py-2 px-4 text-slate-400 dark:text-amber-800 hover:text-amber-600 dark:hover:text-amber-400 transition-colors">
                <i data-lucide="bar-chart-3" class="w-5 h-5 mb-1"></i>
                <span class="text-xs font-medium">Tracker</span>
            </button>
            <button id="nav-planner" class="flex flex-col items-center py-2 px-4 text-slate-400 dark:text-amber-800 hover:text-amber-600 dark:hover:text-amber-400 transition-colors">
                <i data-lucide="calendar-clock" class="w-5 h-5 mb-1"></i>
                <span class="text-xs font-medium">Planner</span>
            </button>
        </div>
    </nav>

    <!-- Tracker View (Hidden by default) -->
    <div id="tracker-view" class="hidden fixed inset-0 bg-amber-50 dark:bg-black z-30 overflow-y-auto">
        <!-- Tracker Header -->
        <header class="fixed top-0 w-full z-50 glass-header">
            <div class="max-w-6xl mx-auto px-4 py-3 md:px-6 md:py-4">
                <div class="flex justify-between items-center mb-3 md:mb-4">
                    <div class="flex items-center gap-3 md:gap-4">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-amber-600 dark:text-amber-400 w-12 h-12 md:w-14 md:h-14">
                            <path d="M18 8h1a4 4 0 0 1 0 8h-1"></path>
                            <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path>
                            <line x1="6" y1="1" x2="6" y2="4"></line>
                            <line x1="10" y1="1" x2="10" y2="4"></line>
                            <line x1="14" y1="1" x2="14" y2="4"></line>
                        </svg>
                        <div>
                            <h1 class="text-sm md:text-base font-semibold tracking-tight text-slate-900 dark:text-gray-100 leading-tight">Syllabus Tracker</h1>
                            <div class="flex items-center gap-2">
                                <span id="tracker-sync-status-dot" class="w-1.5 h-1.5 rounded-full bg-slate-300 transition-colors duration-300"></span>
                                <span id="tracker-sync-status-text" class="text-[9px] md:text-[10px] font-bold uppercase tracking-widest text-slate-400 dark:text-gray-500">Offline</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="window.state.darkMode = !window.state.darkMode; window.saveData();" class="h-8 w-8 md:h-9 md:w-9 rounded-full bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 transition-colors flex items-center justify-center text-slate-500 dark:text-gray-400 focus:outline-none">
                        <svg class="w-4 h-4 dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                        <svg class="w-4 h-4 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    </button>
                </div>
                
                <!-- Global Progress Bar -->
                <div class="flex items-center gap-3 md:gap-4">
                    <div class="flex-1 bg-slate-100 dark:bg-white/5 rounded-full h-1 md:h-1.5 overflow-hidden">
                        <div id="tracker-global-progress" class="bg-slate-900 dark:bg-white h-full rounded-full progress-transition shadow-[0_0_10px_rgba(0,0,0,0.1)] dark:shadow-[0_0_10px_rgba(255,255,255,0.2)]" style="width: 0%"></div>
                    </div>
                    <span id="tracker-global-percentage" class="text-[10px] md:text-xs font-bold text-slate-900 dark:text-white w-7 text-right font-mono">0%</span>
                </div>
            </div>
        </header>

        <!-- Tracker Main Content -->
        <main class="max-w-6xl mx-auto px-4 pt-28 md:px-6 md:pt-36 pb-24">
            <!-- Dashboard Stats -->
            <div class="flex md:grid md:grid-cols-3 overflow-x-auto snap-x snap-mandatory gap-4 mb-6 md:mb-10 pb-4 md:pb-0 hide-scrollbar -mx-4 px-4 md:mx-0 md:px-0">
                <div class="soft-card bg-white dark:bg-card p-5 md:p-6 rounded-2xl flex flex-col justify-between h-28 md:h-32 min-w-[85vw] sm:min-w-[45vw] md:min-w-0 snap-center">
                    <div class="flex justify-between items-start">
                        <p class="text-[9px] md:text-[10px] font-bold uppercase tracking-widest text-slate-400 dark:text-gray-500">Tasks Done</p>
                        <svg class="w-5 h-5 text-emerald-500/80" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    </div>
                    <h3 class="text-2xl md:text-3xl font-semibold tracking-tight text-slate-900 dark:text-gray-100 mt-auto" id="tracker-total-tasks-done">0/0</h3>
                </div>
                
                <div class="soft-card bg-white dark:bg-card p-5 md:p-6 rounded-2xl flex flex-col justify-between h-28 md:h-32 min-w-[85vw] sm:min-w-[45vw] md:min-w-0 snap-center">
                    <div class="flex justify-between items-start">
                        <p class="text-[9px] md:text-[10px] font-bold uppercase tracking-widest text-slate-400 dark:text-gray-500">Current Rank</p>
                        <svg class="w-5 h-5 text-amber-500/80" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    </div>
                    <h3 class="text-2xl md:text-3xl font-semibold tracking-tight text-amber-500 mt-auto" id="tracker-user-rank">Robin</h3>
                </div>

                <div class="soft-card bg-white dark:bg-card p-5 md:p-6 rounded-2xl flex flex-col justify-between h-28 md:h-32 min-w-[85vw] sm:min-w-[45vw] md:min-w-0 snap-center">
                    <div class="flex justify-between items-start">
                        <p class="text-[9px] md:text-[10px] font-bold uppercase tracking-widest text-slate-400 dark:text-gray-500">Focus Area</p>
                        <svg class="w-5 h-5 text-rose-500/80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/><circle cx="12" cy="12" r="3"/></svg>
                    </div>
                    <h3 class="text-xl md:text-2xl font-semibold tracking-tight text-slate-900 dark:text-gray-100 mt-auto truncate" id="tracker-focus-area">Balanced</h3>
                </div>
            </div>

            <!-- Subjects Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                <!-- Physics Section -->
                <div class="soft-card bg-white dark:bg-card rounded-2xl overflow-hidden flex flex-col h-full">
                    <div class="px-5 py-4 md:px-6 md:py-6 border-b border-slate-50 dark:border-white/5 bg-amber-600/5 dark:bg-amber-600/10">
                        <div class="flex justify-between items-end mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-7 h-7 md:w-8 md:h-8 rounded-lg bg-white dark:bg-white/5 flex items-center justify-center text-amber-600 shadow-sm dark:shadow-none dark:border dark:border-white/5">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
                                </div>
                                <h2 class="text-base md:text-lg font-semibold tracking-tight text-slate-900 dark:text-gray-100">Physics</h2>
                            </div>
                            <span id="tracker-physics-text" class="text-[10px] md:text-xs font-bold text-amber-600 font-mono">0%</span>
                        </div>
                        <div class="w-full bg-slate-200/50 dark:bg-white/10 rounded-full h-1">
                            <div id="tracker-physics-bar" class="bg-amber-600 h-1 rounded-full progress-transition" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="tracker-physics-list" class="p-3 md:p-4 space-y-2 flex-grow"></div>
                </div>

                <!-- Chemistry Section -->
                <div class="soft-card bg-white dark:bg-card rounded-2xl overflow-hidden flex flex-col h-full">
                    <div class="px-5 py-4 md:px-6 md:py-6 border-b border-slate-50 dark:border-white/5 bg-amber-600/5 dark:bg-amber-600/10">
                        <div class="flex justify-between items-end mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-7 h-7 md:w-8 md:h-8 rounded-lg bg-white dark:bg-white/5 flex items-center justify-center text-amber-600 shadow-sm dark:shadow-none dark:border dark:border-white/5">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 7.172V5L8 4z"/></svg>
                                </div>
                                <h2 class="text-base md:text-lg font-semibold tracking-tight text-slate-900 dark:text-gray-100">Chemistry</h2>
                            </div>
                            <span id="tracker-chemistry-text" class="text-[10px] md:text-xs font-bold text-amber-600 font-mono">0%</span>
                        </div>
                        <div class="w-full bg-slate-200/50 dark:bg-white/10 rounded-full h-1">
                            <div id="tracker-chemistry-bar" class="bg-amber-600 h-1 rounded-full progress-transition" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="tracker-chemistry-list" class="p-3 md:p-4 space-y-2 flex-grow"></div>
                </div>

                <!-- Maths Section -->
                <div class="soft-card bg-white dark:bg-card rounded-2xl overflow-hidden flex flex-col h-full">
                    <div class="px-5 py-4 md:px-6 md:py-6 border-b border-slate-50 dark:border-white/5 bg-amber-600/5 dark:bg-amber-600/10">
                        <div class="flex justify-between items-end mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-7 h-7 md:w-8 md:h-8 rounded-lg bg-white dark:bg-white/5 flex items-center justify-center text-amber-600 shadow-sm dark:shadow-none dark:border dark:border-white/5">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                                </div>
                                <h2 class="text-base md:text-lg font-semibold tracking-tight text-slate-900 dark:text-gray-100">Maths</h2>
                            </div>
                            <span id="tracker-math-text" class="text-[10px] md:text-xs font-bold text-amber-600 font-mono">0%</span>
                        </div>
                        <div class="w-full bg-slate-200/50 dark:bg-white/10 rounded-full h-1">
                            <div id="tracker-math-bar" class="bg-amber-600 h-1 rounded-full progress-transition" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="tracker-math-list" class="p-3 md:p-4 space-y-2 flex-grow"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Planner View (Hidden by default) -->
    <div id="planner-view" class="hidden fixed inset-0 bg-amber-50 dark:bg-black z-30 overflow-hidden">
        <iframe src="planner.html" class="w-full h-full border-0"></iframe>
    </div>
</body>
</html>
